\chapter{Développement du module d'extension \og qtype\_essayhelper \fg{} }

Le développement d'un module d'extension Moodle n'est pas intuitif.
La documentation n'est pas toujours complète et l'interaction dans le code entre les types de modules d'extensions \og Rapport de questionnaire \fg{}, \og Type de question \fg{} et \og Comportement de question \fg{} n'est pas toujours claire.
Dans le développement de notre module d'extension, le code du module d'extension \og qtype\_essay \fg{} a été utilisé comme documentation.
En prenant ce module d'extension comme base, il a ensuite été plus facile de construire ce qui était désiré.

Les commentaires de \emph{copyrights} ont été ajustés comme illustré à l'exemple de code~\ref{code:commentaire}.

\begin{lstfloat}
\begin{lstlisting}[frame=l]
/**
 * Essay for correction helper question definition class.
 *
 * @package    qtype
 * @subpackage essayhelper
 * @copyright  2018 Philippe Girard
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 *
 * Inspired by:
 * @package    qtype
 * @subpackage essay
 * @copyright  2009 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
\end{lstlisting}
\caption{Exemple des commentaires dans les fichiers du module d'extension.}
\label{code:commentaire}
\end{lstfloat}

\section{Fonctionnalités}

Plusieurs fonctionnalités du module d'extension \og qtype\_essay \fg{} ont été enlevées:

\begin{description}
  \item[Éditeur de texte WYSIWIG]
  
  Cet \'editeur permet de modifier facilement l'apparence du texte.
  Ceci permet, entre autres, de surligner, de souligner, de mettre en gras, de mettre en italique et plus encore.
  Comme on ne peut pas enlever des options WYSIWIG pour un seul module d'extension, cela devient complexe de trouver une mise en forme qui permet de mettre en évidence les mots clés, car un étudiant pourrait, par erreur, reproduire la même mise en forme.
  
  \item[Remise de fichier]
  
  Il est possible d'écrire directement dans la zone de texte ou de remettre un document texte (configurable par l'enseignant).
  Comme le module d'extension n'aidera pas à corriger les textes remis par fichier, cette option a été enlevée.
\end{description}

Plusieurs fonctionnalités sont restées dans le nouveau module d'extension:

\begin{description}
  \item[Rétroaction générale]
  
  Cette fonctionnalit\'e permet de laisser un commentaire à l'étudiant une fois que la correction est termin\'ee.
  Par exemple, l'enseignant pourrait laisser des explications sur les erreurs courantes.
  
  \item[Modèle de réponse]
  
  Ceci permet de préremplir la zone de texte de l'étudiant avec le texte donné.
  Par exemple, un en-tête de fonction pour une question de programmation ou la liste des mots à définir.
  
  \item[Information de l'évaluateur]
  
  Ceci affiche un texte pour le correcteur seulement.
  Utile pour voir facilement le barème de correction ou donner des instructions au correcteur.
  Est affiché sous la réponse de l'étudiant lors de la correction.
\end{description}

Finalement, les fonctionnalités suivantes ont été ajoutées:

\begin{description}
  \item[Mots-clés]
  
  Les mots-clés sont mis en évidence dans la réponse de l'étudiant lors de la correction manuelle.

  \item[Réponse officielle de l'enseignant]
  
  Affiche ce texte à droite de la réponse de l'étudiant lors de la correction.
  Les mots-clés sont mis en évidence aussi dans ce texte.
\end{description}

\section{Détection des mots clés}

Comme cité dans le chapitre \autoref{chap:keywords}, nous utilisons la biblioth\`eque \texttt{php-stemmer} afin de trouver la racine de chaque mot.
Pour trouver la racine de tous les mots du texte, il faut débuter par isoler tous les mots.
Les caractères non alphanumériques sont remplacés par des espaces et le texte est découpé par des caractères d'espacement (espace, saut de ligne, tabulation, etc.).

\GT{Quand tu mets une figure ou un extrait de code, alors tu dois y
r\'ef\'erer dans le texte, en donnant quelques
informations/explications et en mettant une r\'ef\'erence
$\backslash$ref\{\}.}

\begin{lstfloat}
\begin{lstlisting}[frame=l]
$words = preg_split('/(\s|\')/', preg_replace('/[^[:alnum:][:space:]]/u', ' ', $sentence));
\end{lstlisting}
\caption{Isoler les mots du texte.}
\label{code:isoler}
\end{lstfloat}

Ensuite, chaque mot est associé avec sa racine trouvée avec l'algorithme Snowball.
Chaque mot-clé a, préalablement, aussi été réduit à sa racine avec l'algorithme Snowball.

\begin{lstfloat}
\begin{lstlisting}[frame=l]
foreach ($words as $word) {
	if ($word) {
		if (Wamania\Snowball\Utf8::check($word)) {
			$stem = $stemmer->stem($word);
			if (isset($stems[$stem])) {
				if (!in_array($word, $stems[$stem])) {
					$stems[$stem][] = $word;
				}
			} else {
				$stems[$stem] = array($word);
			}
		} else {
			$stems[] = $word;
		}
	}
}
\end{lstlisting}
\caption{Racination des mots avec Snowball.}
\label{code:racinationsnowball}
\end{lstfloat}

Finalement les mots-clés trouvés dans le texte sont mis en évidence.

\begin{lstfloat}
\begin{lstlisting}[frame=l]
$usedKeywords = array_intersect(array_keys($stems), $keywords);

foreach ($usedKeywords as $keyword) {
	$words = $answerWords[$keyword];
	foreach ($words as $word) {
		$studentAnswer = str_replace($word, '<b><u>' . $word . '</u></b>', $studentAnswer);
	}
}
\end{lstlisting}
\caption{Mise en évidence des mots-clés trouvés.}
\label{code:mots-cles}
\end{lstfloat}

\section{Tests}

Les tests du module d'extension \og qtype\_essay \fg{} ont été conservés et adaptés à ce nouveau module d'extension.
Le fonctionnement de base d'un module d'extension (création de question, modification de question, répondre à la question, etc.) a donc facilement été testé.
Il ne restait plus qu'à tester les nouvelles fonctionnalités de mots-clés et d'affichage de la réponse de l'enseignant.

\section{Tests d'acceptation}

Les tests d'acceptation récupérés du module d'extension \textit{qtype\_essay} ont permis de trouver quelques problèmes  dans le nouveau module d'extension.
Par exemple, la fonctionnalité \textit{Backup and restore} ne fonctionnait pas pour les questions avec le nouveau type de question \textit{qtype\_essayhelper}.
Le problème venait d'un dossier manquant dans le nouveau module d'extension.
Le dossier \textit{backup} dans le module d'extension \textit{qtype\_essayhelper} ne contient pas des copies de sauvegardes du module d'extension mais plusieurs versions de la fonctionnalité \textit{Backup and restore}.

\section{Tests unitaires}

La biblioth\`eque de racination \texttt{php-stemmer} est déjà testé unitairement et validé à l'aide d'un dictionnaire qui associe les mots à leurs racines.
Il ne restait donc qu'à tester l'int\'egration entre Moodle et la biblioth\`eque de racination.
